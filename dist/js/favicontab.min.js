"use strict";var idPrefix="bid",positionPrefix="positions",notExistPrefix="notexists",board=document.getElementById("board");document.body.style.backgroundColor=localStorage.backgroundColor;var x=void 0,y=void 0,setPositions={};"1"===localStorage.placement?board.classList.add("manual"):board.classList.add("auto");var faviconDisplay=function(t){var e=document.createElement("main");board.childNodes[0]&&board.removeChild(board.childNodes[0]),t!=localStorage.useFolder&&setBackFolder(t,e),chrome.bookmarks.getChildren(t,function(t){t.forEach(function(t){setIcon(t,e)}),board.appendChild(e)})},faviconDisplayManual=function(t){var a=document.createElement("main"),e=positionPrefix+t,o=JSON.parse(localStorage.getItem(e));board.childNodes[0]&&board.removeChild(board.childNodes[0]),t!=localStorage.useFolder&&setBackFolder(t,a),chrome.bookmarks.getChildren(t,function(t){t.forEach(function(t){if(o&&void 0!==o[t.id]){setPositions[t.id]=o[t.id];var e=o[t.id].split(",");setIcon(t,a).setAttribute("style","position:absolute;top:"+e[0]+"px;left:"+e[1]+"px;")}else setIcon(t,a)}),board.appendChild(a),localStorage.setItem(e,JSON.stringify(setPositions))})},setBackFolder=function(t,o){chrome.bookmarks.get(String(t),function(t){var e=document.createElement("img");if(e.setAttribute("src","/img/folder_open.svg"),e.setAttribute("class","icon folder"),e.setAttribute("id",idPrefix+t[0].parentId),e.setAttribute("data-id",t[0].parentId),e.setAttribute("draggable","false"),"1"===localStorage.placement&&localStorage[positionPrefix+t[0].parentId]&&void 0!==JSON.parse(localStorage[positionPrefix+t[0].parentId])[t[0].id]){var a=JSON.parse(localStorage[positionPrefix+t[0].parentId])[t[0].id].split(",");e.setAttribute("style","position:absolute;top:"+a[0]+"px;left:"+a[1]+"px;")}o.insertBefore(e,o.firstChild)})},setIcon=function(a,t){var e=document.createElement("img"),o=notExistPrefix+a.parentId,r=JSON.parse(localStorage.getItem(o));if(e.addEventListener("dragstart",dragstart,!1),e.setAttribute("id",idPrefix+a.id),e.setAttribute("title",a.title),e.setAttribute("data-id",a.id),e.setAttribute("data-index",a.index),e.setAttribute("data-pid",a.parentId),e.setAttribute("draggable","true"),void 0!==a.url)void 0===r[a.id]?e.setAttribute("src","chrome://favicon/"+a.url):e.setAttribute("src","/img/defaultIcon.png"),e.setAttribute("class","icon favicon"),e.setAttribute("data-url",a.url),e.onload=function(){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,t.getContext("2d").drawImage(this,0,0);if("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVQ4T2NkoBAwIuuPior6j8O8xmXLljVgk8MwYNmyZdgMfcjAwLAAmyFEGfDv3z9FJiamA9gMIcoAkKsiIiIUsBlClAHofkf2JkED0DWDAnrUgOEfBsRkTpzpgBjN6GoA24V1Efr1zoAAAAAASUVORK5CYII="===t.toDataURL()){var e=JSON.parse(localStorage.getItem(o));null==e&&(e={}),e[a.id]=1,localStorage.setItem(o,JSON.stringify(e)),console.log(JSON.stringify(e)),console.log("favicon does not exist")}},t.appendChild(e);else if(e.setAttribute("src","/img/folder.svg"),e.setAttribute("class","icon folder"),e.setAttribute("data-status","close"),"0"===localStorage.placement){var i=document.createElement("span");i.setAttribute("id","parentFolder"+a.id),i.appendChild(e),t.appendChild(i)}else t.appendChild(e);return e},click=function(t){if(void 0===t.target.dataset.id)return!1;if(t.target.dataset.url)switch(localStorage.linkTarget){case"0":window.location.href=t.target.dataset.url;break;case"1":window.open(t.target.dataset.url,"_blank")}else"1"===localStorage.folderType&&"0"===localStorage.placement?"close"===t.target.dataset.status?openFolder(t.target.dataset.id):closeFolder(t.target.dataset.id):"0"===localStorage.placement?faviconDisplay(t.target.dataset.id):faviconDisplayManual(t.target.dataset.id)},dragstart=function(t){var e=document.getElementById(t.target.id);e.classList.add("draging"),x=t.pageX-this.offsetLeft,y=t.pageY-this.offsetTop,"1"===localStorage.placement&&e.addEventListener("drag",drag,!1)},drag=function(t){var e=document.getElementsByClassName("draging");e[0].style.position="absolute",e[0].style.top=t.pageY-y+"px",e[0].style.left=t.pageX-x+"px",e[0].addEventListener("dragend",dragend,!1),e[0].addEventListener("dragover",dragover,!1)},dragend=function(t){var e=document.getElementsByClassName("draging");if("1"===localStorage.placement){var a=e[0].style.top.slice(0,-2),o=e[0].style.left.slice(0,-2);if(Number(o)<0||Number(a)<0)if(setPositions[t.target.dataset.id]){var r=setPositions[t.target.dataset.id].split(",");e[0].style.top=r[0]+"px",e[0].style.left=r[1]+"px"}else e[0].style.position="none",e[0].style.top=null,e[0].style.left=null;else{var i=positionPrefix+t.target.dataset.pid;setPositions[t.target.dataset.id]=a+","+o,localStorage.setItem(i,JSON.stringify(setPositions))}}e[0].classList.remove("draging")},dragover=function(t){t.preventDefault(),t.dataTransfer.dropEffect="move"},drop=function(t){if(void 0!==t.target.dataset.id){var e=document.getElementsByClassName("draging"),a=e[0].dataset.id,o=Number(t.target.dataset.index);t.target.dataset.url?(o>e[0].dataset.index&&(o+=1),chrome.bookmarks.move(a,{index:o})):chrome.bookmarks.move(a,{parentId:t.target.dataset.id}),faviconDisplay(t.target.dataset.pid)}},openFolder=function(t){var e=document.getElementById(idPrefix+t);e.setAttribute("data-status","open"),e.setAttribute("src","/img/folder_open.svg");var a=document.getElementById("parentFolder"+t),o=document.createElement("span");o.setAttribute("id","childFolder"+t),a.appendChild(o),chrome.bookmarks.getChildren(t,function(t){t.forEach(function(t){setIcon(t,o)})})},closeFolder=function(t){var e=document.getElementById(idPrefix+t);e.setAttribute("data-status","close"),e.setAttribute("src","/img/folder.svg"),document.getElementById("childFolder"+t).remove()};board.addEventListener("click",click,!1),"0"===localStorage.placement&&(board.addEventListener("dragover",dragover,!1),board.addEventListener("drop",drop,!1)),"0"===localStorage.placement?faviconDisplay(localStorage.useFolder):faviconDisplayManual(localStorage.useFolder);